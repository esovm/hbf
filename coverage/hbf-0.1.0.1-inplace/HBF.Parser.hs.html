<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
span.lineno { color: white; background: #aaaaaa; border-right: solid white 12px }
span.nottickedoff { background: yellow}
span.istickedoff { background: white }
span.tickonlyfalse { margin: -1px; border: 1px solid #f20913; background: #f20913 }
span.tickonlytrue  { margin: -1px; border: 1px solid #60de51; background: #60de51 }
span.funcount { font-size: small; color: orange; z-index: 2; position: absolute; right: 20 }
span.decl { font-weight: bold }
span.spaces    { background: white }
</style>
</head>
<body>
<pre>
<span class="decl"><span class="nottickedoff">never executed</span> <span class="tickonlytrue">always true</span> <span class="tickonlyfalse">always false</span></span>
</pre>
<pre>
<span class="lineno">    1 </span>{-|
<span class="lineno">    2 </span>Description : Brainfuck parsing
<span class="lineno">    3 </span>Copyright   : (c) Sebastian Galkin, 2018
<span class="lineno">    4 </span>License     : GPL-3
<span class="lineno">    5 </span>
<span class="lineno">    6 </span>Parsing 'Text' into 'Program' 'Unparsed'
<span class="lineno">    7 </span>-}
<span class="lineno">    8 </span>module HBF.Parser
<span class="lineno">    9 </span>  ( module HBF.Parser
<span class="lineno">   10 </span>  -- * Reexport from &quot;Text.Parsec&quot;
<span class="lineno">   11 </span>  , Text.Parsec.ParseError
<span class="lineno">   12 </span>  ) where
<span class="lineno">   13 </span>
<span class="lineno">   14 </span>import           Control.Applicative   ((&lt;|&gt;))
<span class="lineno">   15 </span>import           Data.Text.Lazy        (Text)
<span class="lineno">   16 </span>import           Text.Parsec           (ParseError, between, eof, many, many1,
<span class="lineno">   17 </span>                                        runP)
<span class="lineno">   18 </span>import           Text.Parsec.Char      (char, noneOf, oneOf)
<span class="lineno">   19 </span>import           Text.Parsec.Text.Lazy (Parser)
<span class="lineno">   20 </span>
<span class="lineno">   21 </span>import           HBF.Types
<span class="lineno">   22 </span>
<span class="lineno">   23 </span>-- $setup
<span class="lineno">   24 </span>-- &gt;&gt;&gt; :set -XOverloadedStrings
<span class="lineno">   25 </span>-- &gt;&gt;&gt; import Data.Either
<span class="lineno">   26 </span>-- &gt;&gt;&gt; let parse :: Parser a -&gt; Text -&gt; Either ParseError a; parse p text = runP p () &quot;&quot; text
<span class="lineno">   27 </span>
<span class="lineno">   28 </span>
<span class="lineno">   29 </span>-- | Parser for a full 'Program'.
<span class="lineno">   30 </span>--
<span class="lineno">   31 </span>-- &gt;&gt;&gt; isRight $ parse program &quot;  +[-&gt;&gt;+  +[&lt;] ##garbage## ],.[-]  can ignore garbage&quot;
<span class="lineno">   32 </span>-- True
<span class="lineno">   33 </span>program :: Parser (Program Unoptimized)
<span class="lineno">   34 </span><span class="decl"><span class="istickedoff">program = Program &lt;$&gt; many1 operation</span></span>
<span class="lineno">   35 </span>
<span class="lineno">   36 </span>-- | Parser for an 'Op', ignoring unknown characters.
<span class="lineno">   37 </span>--
<span class="lineno">   38 </span>-- &gt;&gt;&gt; parse operation &quot;  +///&quot;
<span class="lineno">   39 </span>-- Right (Inc 1 0)
<span class="lineno">   40 </span>--
<span class="lineno">   41 </span>-- &gt;&gt;&gt; parse operation &quot;fooo  [+&gt;]  baaar  &quot;
<span class="lineno">   42 </span>-- Right (Loop [Inc 1 0,Move 1])
<span class="lineno">   43 </span>operation :: Parser Op
<span class="lineno">   44 </span><span class="decl"><span class="istickedoff">operation = many garbage *&gt; (simpleOp &lt;|&gt; loopOp) &lt;* many garbage</span></span>
<span class="lineno">   45 </span>
<span class="lineno">   46 </span>-- | The characters allowed in a Brainfuck program except for the loop characters @[@ and @]@.
<span class="lineno">   47 </span>bfSimpleTokens :: String
<span class="lineno">   48 </span><span class="decl"><span class="istickedoff">bfSimpleTokens = &quot;&gt;&lt;+-.,&quot;</span></span>
<span class="lineno">   49 </span>
<span class="lineno">   50 </span>-- | The characters allowed in a Brainfuck program.
<span class="lineno">   51 </span>bfTokens :: String
<span class="lineno">   52 </span><span class="decl"><span class="istickedoff">bfTokens = &quot;[]&quot; ++ bfSimpleTokens</span></span>
<span class="lineno">   53 </span>
<span class="lineno">   54 </span>-- | Parser for unknown characters
<span class="lineno">   55 </span>--
<span class="lineno">   56 </span>-- &gt;&gt;&gt; parse garbage &quot;this is @#! garbage&quot;
<span class="lineno">   57 </span>-- Right 't'
<span class="lineno">   58 </span>--
<span class="lineno">   59 </span>-- &gt;&gt;&gt; isLeft $ parse garbage &quot;+&quot;
<span class="lineno">   60 </span>-- True
<span class="lineno">   61 </span>garbage :: Parser Char
<span class="lineno">   62 </span><span class="decl"><span class="istickedoff">garbage = noneOf bfTokens</span></span>
<span class="lineno">   63 </span>
<span class="lineno">   64 </span>-- | Parser for simple operations (not loops).
<span class="lineno">   65 </span>--
<span class="lineno">   66 </span>-- &gt;&gt;&gt; parse simpleOp &quot;&gt;&quot;
<span class="lineno">   67 </span>-- Right (Move 1)
<span class="lineno">   68 </span>--
<span class="lineno">   69 </span>-- &gt;&gt;&gt; parse simpleOp &quot;.&quot;
<span class="lineno">   70 </span>-- Right (Out 1 0)
<span class="lineno">   71 </span>simpleOp :: Parser Op
<span class="lineno">   72 </span><span class="decl"><span class="istickedoff">simpleOp = build &lt;$&gt; oneOf bfSimpleTokens</span>
<span class="lineno">   73 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">   74 </span><span class="spaces">    </span><span class="istickedoff">build '&gt;' = Move 1</span>
<span class="lineno">   75 </span><span class="spaces">    </span><span class="istickedoff">build '&lt;' = Move (-1)</span>
<span class="lineno">   76 </span><span class="spaces">    </span><span class="istickedoff">build '+' = Inc 1 0</span>
<span class="lineno">   77 </span><span class="spaces">    </span><span class="istickedoff">build '-' = Inc (-1) 0</span>
<span class="lineno">   78 </span><span class="spaces">    </span><span class="istickedoff">build '.' = Out 1 0</span>
<span class="lineno">   79 </span><span class="spaces">    </span><span class="istickedoff">build ',' = In 1 0</span>
<span class="lineno">   80 </span><span class="spaces">    </span><span class="istickedoff">build _   = <span class="nottickedoff">error &quot;Unknown character&quot;</span></span></span>
<span class="lineno">   81 </span>
<span class="lineno">   82 </span>-- | Parser for loops.
<span class="lineno">   83 </span>--
<span class="lineno">   84 </span>-- &gt;&gt;&gt; parse loopOp &quot;[+-]&quot;
<span class="lineno">   85 </span>-- Right (Loop [Inc 1 0,Inc (-1) 0])
<span class="lineno">   86 </span>loopOp :: Parser Op
<span class="lineno">   87 </span><span class="decl"><span class="istickedoff">loopOp = Loop . instructions &lt;$&gt; between (char '[') (char ']') program</span></span>
<span class="lineno">   88 </span>
<span class="lineno">   89 </span>-- | Parse program stream. Returns an error or the parsed 'Program'
<span class="lineno">   90 </span>parseProgram :: Text -&gt; Either ParseError (Program Unoptimized)
<span class="lineno">   91 </span><span class="decl"><span class="istickedoff">parseProgram = runP (program &lt;* eof) () <span class="nottickedoff">&quot;&quot;</span></span></span>

</pre>
</body>
</html>
