stages:
  - test
  - deploy



test:
  stage: test

  image: nixos/nix:latest

  before_script:
    - nix-channel --add https://nixos.org/channels/nixpkgs-unstable nixpkgs
    - nix-channel --update

  script:
    - nix-shell --attr withCabal release.nix --run 'cabal configure --enable-test && cabal build && ./dist/build/test/test && ./dist/build/evalbench -o bench.html'

  artifacts:
    paths:
      - bench.html

pages:
  stage: deploy

  dependencies:
    - test

  before_script:
    - mkdir public

  script:
    - mv bench.html public/

  artifacts:
    paths:
      - public

  only:
    - master
